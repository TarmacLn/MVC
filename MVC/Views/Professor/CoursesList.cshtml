@using MVC.Models
@model IEnumerable<MVC.Models.Course>

@{
    ViewData["Title"] = "Courses & Grades";
    var successMessage = TempData["SuccessMessage"] as string;
    var errorMessage = TempData["ErrorMessage"] as string;
}

<a asp-action="Index" asp-controller="Professor" class="btn btn-secondary">Back</a>

<br>

<h2>Your Courses</h2>
<p>View and manage grades for enrolled students in your courses</p>

@if (!string.IsNullOrEmpty(successMessage)) {
    <div class="alert alert-success" role="alert">@successMessage</div>
}

@if (!string.IsNullOrEmpty(errorMessage)) {
    <div class="alert alert-danger" role="alert">@errorMessage</div>
}

<br>

@if (!Model.Any())
{
    <div class="alert alert-info">
        <p>You don't have any courses assigned yet.</p>
    </div>
}
else
{
    @foreach (var course in Model.OrderBy(c => c.Semester))
    {
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">@course.Title - Semester @course.Semester</h5>
            </div>
            <div class="card-body">
                @if (!course.CourseHasStudents.Any())
                {
                    <p class="text-muted">No students enrolled in this course.</p>
                }
                else
                {
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Student Name</th>
                                <th>Grades</th>
                                <th>Final Grade</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var students = course.CourseHasStudents
                                    .Select(chs => chs.StudentId)
                                    .Distinct()
                                    .ToList();
                            }
                            @foreach (var studentId in students)
                            {
                                var studentGrades = course.CourseHasStudents
                                    .Where(chs => chs.StudentId == studentId)
                                    .ToList();
                                
                                var student = studentGrades.First().Student;
                                var finalGrade = studentGrades.FirstOrDefault(g => g.IsFinal == true);
                                var partialGrades = studentGrades.Where(g => g.IsFinal != true).ToList();
                                
                                <tr>
                                    <td>@student.UserId</td>
                                    <td>@student.Fullname</td>
                                    <td>
                                        @if (partialGrades.Any())
                                        {
                                            <ul class="list-unstyled mb-0">
                                                @foreach (var grade in partialGrades.OrderBy(g => g.Id))
                                                {
                                                    <li>
                                                        <small>
                                                            <strong>@grade.Grade</strong>
                                                            @if (!string.IsNullOrEmpty(grade.Description))
                                                            {
                                                                <span> - @grade.Description</span>
                                                            }
                                                        </small>
                                                    </li>
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <small class="text-muted">No partial grades</small>
                                        }
                                    </td>
                                    <td>
                                        @if (finalGrade != null)
                                        {
                                            <strong class="text-success">@finalGrade.Grade</strong>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (finalGrade == null)
                                        {
                                            <a asp-action="AddGrade" 
                                               asp-route-courseId="@course.CourseId" 
                                               asp-route-studentId="@studentId" 
                                               class="btn btn-sm btn-success">
                                                <i class="bi bi-plus"></i> Add Grade
                                            </a>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-secondary" disabled>
                                                <i class="bi bi-check"></i> Final Grade Set
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    }
}
